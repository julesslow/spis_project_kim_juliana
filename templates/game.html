<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>NekoNote!</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu&display=swap" rel="stylesheet">  

<style>
    body {
    font-family: 'Gaegu', sans-serif;
    background-color: #fff7fc;
    color: #000000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
    overflow: hidden;
    }

    title {
        font-size: 30px;
        font-weight: bold;
    }

    #game-area {
        width: 800px;
        height: 600px;
        background-color: #fff7fc;
        position: relative;
        overflow: hidden;
    }
    #game-background {
        width: 800px;
        position: relative;
    }

    .note {
        position: absolute;
        width: 50px;
        height: 50px;
        background-color: #e53e3e;
        border-radius: 50%;
        border: 2px solid #fed7d7;
        cursor: pointer;
        transition: transform 0.1s ease-in-out;
    }

    .note:hover {
        transform: scale(1.1);
    }

    #hit-zone {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 50px;
        background-color: #C6D998;
        opacity: 0.8;
    }

    #score-display {
        font-size: 2rem;
        font-weight: bold;
        color: #C6D998;
        margin-bottom: 20px;
    }

    .game-over-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        font-size: 2.5rem;
        font-weight: bold;
        color: #fc8181;
        z-index: 10;
    }

    .logo img {
        width: 300px;
        height: auto;
        top: 0px;
    }
</style>

</head>
<!-- <div class="text-4xl font-bold mb-4">NekoNote!</div> -->
<div class="logo">
    <img src="https://cdn.discordapp.com/attachments/673327829160689674/1412578903582834709/logo.png?ex=68b8ce1f&is=68b77c9f&hm=1e7e4f8a96729dbff8062941455744e2c06952a0e8f75ae0126f7fa7468b547a" alt="NekoNote">
</div>
<div id="score-display">Score: 0</div>
<div id="game-area">
<img id="game-background" src="https://cdn.discordapp.com/attachments/673327829160689674/1413093443265101825/game_area.png?ex=68baad52&is=68b95bd2&hm=9948890fc8513e1c77e786f9d528996027a8fc601c2ab6fd7ad041a04e8ffdc6" class="game-background";>
<!-- The visual hit zone at the bottom of the game area -->
<div id="hit-zone"></div>
</div>
<div id="beatmap-data" class="bg-gray-700 p-4 rounded-lg text-left text-sm font-mono overflow-auto mt-4 w-full max-w-lg">
<p class="text-gray-300">Loading beatmaps...</p>
</div>
<div class="mt-8">
<!-- The button is now disabled by default until the beatmaps are loaded -->
<button id="startButton" disabled class="px-6 py-3 bg-indigo-600 rounded-full font-bold text-lg text-white opacity-50 cursor-not-allowed transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">Start Game</button>
</div>

<script>
    const gameArea = document.getElementById('game-area');
    const startButton = document.getElementById('startButton');
    const scoreDisplay = document.getElementById('score-display');
    const dataContainer = document.getElementById('beatmap-data');
    
    
    let allBeatmaps = {};
    let notesOnScreen = [];
    let score = 0;
    const noteSpeed = 3; // pixels per frame
    // This is a calculated value to make notes fall at a consistent speed.
    // It's not directly used for scheduling notes anymore.
    const fallDuration = gameArea.clientHeight / noteSpeed; 

    function createNote(x) {
        const note = document.createElement('img');
        note.src = "https://cdn.discordapp.com/attachments/673327829160689674/1412684785117302895/green_note.png?ex=68ba823b&is=68b930bb&hm=1544bcf180130bb58132b394d955f841b07dd0a3b27ff6a1186d1384cbe486e5&";
        note.className = 'note';
        note.style.left = `${x}px`;
        note.style.top = `0px`; // Notes will now always start at the very top.
        gameArea.appendChild(note);

        notesOnScreen.push(note);
        
        // note.addEventListener('click', () => {
        //     // Check if the note is within the hit zone
        //     const noteBottom = note.offsetTop + note.clientHeight;
        //     const hitZoneTop = gameArea.clientHeight - document.getElementById('hit-zone').clientHeight;

        //     if (noteBottom > hitZoneTop) {
        //         note.remove();
        //         notesOnScreen = notesOnScreen.filter(n => n !== note);
        //         score += 10;
        //         scoreDisplay.textContent = `Score: ${score}`;
        //     }
        // });
    }

    function animate() {
        for (let i = 0; i < notesOnScreen.length; i++) {
            const note = notesOnScreen[i];
            const currentTop = parseInt(note.style.top, 10);
            note.style.top = `${currentTop + noteSpeed}px`;
            
            if (currentTop > gameArea.clientHeight) {
                note.remove();
                notesOnScreen.splice(i, 1);
                i--;
            }
        }
        requestAnimationFrame(animate);
    }

    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    async function loadAllBeatmaps(songName) {
        console.log(`Attempting to load beatmaps for song: ${songName}`);
        dataContainer.innerHTML = `<p class="text-gray-300">Searching for beatmaps...</p>`;
        
        try {
            // First, fetch the list of available beatmap files from the server.
            const response = await fetch(`/get_beatmap_files/${songName}`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to get beatmap list: ${response.status} ${response.statusText}. Server message: ${errorText}`);
            }
            const beatmapFiles = await response.json();
            
            if (!Array.isArray(beatmapFiles) || beatmapFiles.length === 0) {
                console.error("The server returned an empty or invalid list of beatmap files.");
                dataContainer.innerHTML = `<p class="text-red-500">Error: No valid beatmap files found. Please ensure .txt files are in the 'beatmaps' folder and your server is running.</p>`;
                return;
            }

            dataContainer.innerHTML = `<p class="text-gray-300">Found ${beatmapFiles.length} beatmap file(s).</p>`;
            console.log(`Found beatmap files:`, beatmapFiles);
            
            let validBeatmapsLoaded = 0;

            for (const filename of beatmapFiles) {
                if (filename.endsWith('.json')) {
                    dataContainer.innerHTML += `<p class="text-gray-300">Fetching <strong>${filename}</strong>...</p>`;
                    
                    // FIX: Change the URL to fetch the JSON beatmap, as the server serves these
                    // instead of the raw text files.
                    const beatmapResponse = await fetch(`/beatmaps_json/${filename}`);
                    
                    if (!beatmapResponse.ok) {
                        const errorText = await beatmapResponse.text();
                        console.error(`Failed to load beatmap file: ${filename}. Server message: ${errorText}`);
                        dataContainer.innerHTML += `<p class="text-red-500">Error: Could not load <strong>${filename}</strong>. Check if the file exists on the server.</p>`;
                        continue; // Skip to the next file
                    }
                    
                    // FIX: Parse the response as JSON instead of plain text.
                    const beatmapData = await beatmapResponse.json();
                    
                    // FIX: Get the 'notes' array directly from the JSON object.
                    const notes = beatmapData.notes;

                    if (notes.length > 0) {
                        allBeatmaps[filename] = { notes };
                        console.log(`Loaded and parsed ${filename}:`, allBeatmaps[filename]);
                        validBeatmapsLoaded++;
                    } else {
                        console.warn(`Skipped ${filename}: No valid notes found in the file.`);
                        dataContainer.innerHTML += `<p class="text-yellow-500">Warning: Found a beatmap file but it contained no valid notes: <strong>${filename}</strong></p>`;
                    }
                }
            }

            if (validBeatmapsLoaded > 0) {
                dataContainer.innerHTML = `<p class="text-green-500">All beatmaps loaded successfully! Click Start Game.</p>`;
                startButton.disabled = false;
                startButton.classList.remove('opacity-50', 'cursor-not-allowed');
                startButton.classList.add('hover:bg-indigo-700');
                console.log('All beatmaps loaded successfully.');
            } else {
                dataContainer.innerHTML = `<p class="text-red-500">Error: No valid beatmap .json files were found. Please check the 'beatmaps_json' folder and ensure files have a .json extension and a valid ` + "`time`" + ` format.</p>`;
                console.error("No valid beatmap .json files found.");
            }
            
        } catch (error) {
            console.error('Error loading beatmaps:', error);
            dataContainer.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const songName = getUrlParameter('song_name');
        if (songName) {
            loadAllBeatmaps(songName);
        } else {
            dataContainer.innerHTML = `<p class="text-red-500">Error: No song name found in URL.</p>`;
            console.error("No song name found in URL.");
        }
    });

    startButton.addEventListener('click', () => {
        const beatmapFilenames = Object.keys(allBeatmaps);
        if (beatmapFilenames.length > 0) {
            const firstBeatmapData = allBeatmaps[beatmapFilenames[0]];
            const secondBeatmapData = allBeatmaps[beatmapFilenames[1]];
            firstBeatmapData.notes.forEach(note => {
                // FIX: This now schedules the note creation based on the note's exact
                // timestamp, ensuring all notes are created. The note will then fall
                // at a consistent speed, taking `fallDuration` to reach the bottom.
                setTimeout(() => {
                    createNote(200);
                }, note.y*1000);
            });

            secondBeatmapData.notes.forEach(note => {
                // FIX: This now schedules the note creation based on the note's exact
                // timestamp, ensuring all notes are created. The note will then fall
                // at a consistent speed, taking `fallDuration` to reach the bottom.
                setTimeout(() => {
                    createNote(400);
                }, note.y*1000);
            });

            animate();
            startButton.disabled = true;
            gameRunning = true; // FIX: The gameRunning variable is now set to true.


        } else {
            // This block should now be unreachable since the button is only enabled when data is present.
            // It's kept for extreme debugging purposes.
            console.error("No beatmap data available to start the game.");
        }
    });

    document.addEventListener('keydown', (event) => {
        if (!gameRunning) return;

        // Define the lanes and their corresponding x-coordinates.
        const keyToLaneX = {
            'KeyQ': 200,
            'KeyP': 400,
        };

        const targetX = keyToLaneX[event.code];
        if (targetX === undefined) {
            // If the pressed key is not one of our defined keys, do nothing.
            return;
        }

        const hitZoneTop = gameArea.clientHeight - document.getElementById('hit-zone').clientHeight;

        // Iterate through the notes from last to first to process the latest note first.
        for (let i = notesOnScreen.length - 1; i >= 0; i--) {
            const note = notesOnScreen[i];
            const noteBottom = note.offsetTop + note.clientHeight;
            const noteX = parseInt(note.style.left, 10);

            // Check if the note is in the hit zone AND in the correct lane
            if (noteBottom > hitZoneTop && noteX === targetX) {
                note.remove();
                notesOnScreen.splice(i, 1);
                score += 10;
                scoreDisplay.textContent = `Score: ${score}`;
                break; // Only hit one note per key press
            }
        }
    });

</script>

</body>
</html>

